@page "/counter"
@rendermode InteractiveAuto
@using Microsoft.AspNetCore.Components.Forms

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="foodName" 
                         Label="نام غذا" 
                         Variant="Variant.Outlined"
                         Required="true"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Restaurant" />

            <MudTextField @bind-Value="description" 
                         Label="توضیحات" 
                         Variant="Variant.Outlined"
                         Lines="3" />

            <MudNumericField @bind-Value="price" 
                            Label="قیمت (تومان)" 
                            Variant="Variant.Outlined"
                            Min="0"
                            Adornment="Adornment.End"
                            AdornmentText="تومان" />

            <MudSelect T="string" 
                      @bind-Value="category" 
                      Label="دسته‌بندی" 
                      Variant="Variant.Outlined">
                <MudSelectItem Value="@("ایرانی")">ایرانی</MudSelectItem>
                <MudSelectItem Value="@("فست فود")">فست فود</MudSelectItem>
                <MudSelectItem Value="@("بین‌المللی")">بین‌المللی</MudSelectItem>
                <MudSelectItem Value="@("سنتی")">سنتی</MudSelectItem>
            </MudSelect>

            <MudFileUpload T="IBrowserFile" 
                          @bind-Files="selectedFile" 
                          Accept="image/*"
                          MaximumFileCount="1">
                          <ActivatorContent>
                    <MudButton  
                              HtmlTag="label"
                              Variant="Variant.Outlined"
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.CloudUpload"
                              >
                        انتخاب تصویر غذا
                    </MudButton>
                    </ActivatorContent>
                <SelectedTemplate>
                    @if (context != null)
                    {
                        <MudChip T="string" Color="Color.Success" 
                                Icon="@Icons.Material.Filled.AttachFile">
                            @context.Name
                        </MudChip>
                    }
                </SelectedTemplate>
            </MudFileUpload>

            @if (imagePreview != null)
            {
                <MudImage Src="@imagePreview" 
                         Alt="پیش‌نمایش" 
                         Elevation="2" 
                         Class="rounded-lg" 
                         ObjectFit="ObjectFit.Cover"
                         Height="200" />
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">انصراف</MudButton>
        <MudButton OnClick="Submit" Color="Color.Success" Variant="Variant.Filled">افزودن</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;

    private string foodName = "";
    private string description = "";
    private decimal price = 0;
    private string category = "ایرانی";
    private IBrowserFile? selectedFile;
    private string? imagePreview;

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(foodName))
        {
            return;
        }

        // اینجا کد آپلود تصویر و ارسال به API
        if (selectedFile != null)
        {
            var buffer = new byte[selectedFile.Size];
            await selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
            imagePreview = $"data:{selectedFile.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }

        MudDialog.Close(DialogResult.Ok(foodName));
    }

    private void Cancel() => MudDialog.Cancel();
}