@page "/manage-food"
@using GhazaSystem.Common.Services
@using GhazaSystem.UI.Components.Dialog
@using GhazaSystem.UI.Components.Dialog.Food
@using GhazaSystem.UI.Services
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject FoodServices foodServices
@inject DailyFoodServices dailyFoodServices
@inject PersianCalendarService psc
@inject ProtectedLocalStorage LStorage
@inject NavigationManager NManager
@inject UserServices userServices


<PageTitle>مدیریت غذای ماهانه</PageTitle>

<MudRTLProvider RightToLeft="true">
    <div style="height: 100vh; display: flex; flex-direction: column; background-color: #f5f5f5;">
        
        <!-- هدر ثابت -->
        <MudPaper Elevation="2" Square="true" Class="pa-4" Style="flex-shrink: 0;">
            <MudStack Spacing="3">
                <!-- ردیف اول: عنوان و دکمه رفرش -->
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h5" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.ManageAccounts" Class="ml-2" />
                        مدیریت برنامه غذایی
                    </MudText>
                    
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Refresh"
                              Size="Size.Small"
                              OnClick="LoadData">
                        بروزرسانی
                    </MudButton>
                </MudStack>

                <MudDivider />

                <!-- ردیف دوم: انتخابگرها و دکمه‌های عملیات -->
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <!-- انتخاب ماه و سال -->
                    <MudStack Row="true" Spacing="2">
                        <MudSelect T="int" 
                                  @bind-Value="selectedMonth"
                                  SelectedValuesChanged="@(() => ChangeMont())"
                                  Label="ماه" 
                                  Variant="Variant.Outlined" 
                                  Dense="true"
                                  Style="min-width: 150px;"
                                  >
                            <MudSelectItem Value="1">فروردین</MudSelectItem>
                            <MudSelectItem Value="2">اردیبهشت</MudSelectItem>
                            <MudSelectItem Value="3">خرداد</MudSelectItem>
                            <MudSelectItem Value="4">تیر</MudSelectItem>
                            <MudSelectItem Value="5">مرداد</MudSelectItem>
                            <MudSelectItem Value="6">شهریور</MudSelectItem>
                            <MudSelectItem Value="7">مهر</MudSelectItem>
                            <MudSelectItem Value="8">آبان</MudSelectItem>
                            <MudSelectItem Value="9">آذر</MudSelectItem>
                            <MudSelectItem Value="10">دی</MudSelectItem>
                            <MudSelectItem Value="11">بهمن</MudSelectItem>
                            <MudSelectItem Value="12">اسفند</MudSelectItem>
                        </MudSelect>
                    </MudStack>

                    <!-- دکمه‌های عملیات -->
                    <MudStack Row="true" Spacing="2">
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Success" 
                                  StartIcon="@Icons.Material.Filled.Add"
                                  Size="Size.Small"
                                  OnClick="OpenAddFoodDialog">
                            افزودن غذا
                        </MudButton>

                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Warning" 
                                  StartIcon="@Icons.Material.Filled.Edit"
                                  Size="Size.Small"
                                  OnClick="OpenEditFoodDialog">
                            ویرایش غذا
                        </MudButton>

                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Error" 
                                  StartIcon="@Icons.Material.Filled.Delete"
                                  Size="Size.Small"
                                  OnClick="OpenDeleteFoodDialog">
                            حذف غذا
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudStack>
        </MudPaper>

        <!-- بخش اسکرول -->
        <div style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px;">
            <MudStack Spacing="3">
                
                 <!-- ساخت بخش داینامیک بر اساس دیتا ماه های گرفته شده -->

                @foreach(var week in mont.MontWeek!)
                {

                    <MudPaper Elevation="2" Class="pa-3">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.DateRange" Size="Size.Small" Class="ml-1" />
                                @psc.GetPersianMontName(mont.MonthNumber)  @week.FirstDay ام تا @week.LastDay ام
                        </MudText>
                        
                        <!-- دکمه قفل هفته -->
                        <MudToggleIconButton @bind-Toggled="@week1Locked"
                                            Icon="@Icons.Material.Filled.LockOpen" 
                                            ToggledIcon="@Icons.Material.Filled.Lock"
                                            Color="@Color.Default"
                                            ToggledColor="@Color.Error"
                                            Size="Size.Small"
                                            Title="@(week1Locked ? "قفل شده" : "قفل نشده")" />
                    </MudStack>
                    
                    <div style="display: flex; gap: 8px;">

                          @foreach (var day in week.WeekDay!)
                          {
                                <div style="flex: 1; min-width: 0;">
                                    @if(day == null){}
                                    else if (day.DayName == "جمعه")
                                    {
                                        <MudCard Elevation="1" Class="mud-height-full" Style="background-color: #fafafa;">
                                            <MudCardContent Class="pa-3 d-flex flex-column align-center justify-center" Style="min-height: 200px;">
                                                <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                                    <MudText Typo="Typo.subtitle2" Color="Color.Default" Style="font-weight: 600;">@day.DayName</MudText>
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">@day.DayNumber</MudChip>
                                                    <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Large" Color="Color.Default" Class="mt-2" />
                                                    <MudText Typo="Typo.caption" Color="Color.Default">تعطیل</MudText>
                                                </MudStack>
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                    else
                                    {
                                        <MudCard Elevation="3" Class="mud-height-full">
                                            <MudCardContent Class="pa-3">
                                                <MudStack Spacing="2">
                                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                                                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Style="font-weight: 600;">@day.DayName</MudText>
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">@day.DayNumber</MudChip>
                                                    </MudStack>

                                                    <MudSelect T="Food"
                                                               FullWidth="true"
                                                               MultiSelection="true"
                                                               SelectedValuesChanged="@((selectedFoods) => OnSelectionChanged(selectedFoods, day.GregorianDate))"
                                                               Label="انتخاب غذا"
                                                               Variant="Variant.Outlined"
                                                               Dense="false"
                                                               Disabled="@week1Locked"
                                                               AdornmentIcon="@Icons.Material.Filled.Restaurant"
                                                               AdornmentColor="Color.Primary">
                                                        @foreach (var food in availableFoods)
                                                        {
                                                            <MudSelectItem T="Food" Value="@food"
                                                                           Style=" display: flex;
                                                                                               flex-direction: row-reverse;
                                                                                               padding-left:0;padding-right:0;
                                                                                             ">
                                                                <MudChip T="Food" Style="width: 95%;
                                                                                                     justify-content: space-between;
                                                                                                    ">
                                                                    <ChildContent>@food.Name</ChildContent>
                                                                    <AvatarContent>
                                                                        <MudAvatar>
                                                                            <MudImage Src=@food.Photos></MudImage>
                                                                        </MudAvatar>
                                                                    </AvatarContent>

                                                                </MudChip>
                                                            </MudSelectItem>
                                                        }
                                                    </MudSelect>

                                                    @foreach (var item in List_Daily_FoodDTOs)
                                                    {
                                                        
                                                            @if (item.Date == day.GregorianDate)
                                                            {
                                                            <MudStack Spacing="1" Class="mt-2">
                                                                <MudChip T="Food" Style="width: 95%;
                                                                                                                         justify-content: space-between;
                                                                                                                        ">
                                                                    <ChildContent>@item.food.Name</ChildContent>
                                                                    <AvatarContent>
                                                                        <MudAvatar>
                                                                            <MudImage Src=@item.food.Photos></MudImage>
                                                                        </MudAvatar>
                                                                    </AvatarContent>

                                                                </MudChip>
                                                            </MudStack>
                                                            }
                                                        
                                                    }
                                                </MudStack>
                                            </MudCardContent>
                                        </MudCard>
                                    }



                                    </div>

                           }
                        </div>
                    </MudPaper>
                }

                <!-- دکمه ذخیره -->
                <MudPaper Elevation="2" Class="pa-4">
                    <MudStack Row="true" Justify="Justify.Center" Spacing="2">
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Success" 
                                  Size="Size.Large"
                                  StartIcon="@Icons.Material.Filled.Save"
                                  OnClick="SaveChanges">
                            ذخیره تغییرات
                        </MudButton>

                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Default" 
                                  Size="Size.Large"
                                  StartIcon="@Icons.Material.Filled.Cancel"
                                  OnClick="CancelChanges">
                            انصراف
                        </MudButton>
                    </MudStack>
                </MudPaper>

            </MudStack>
        </div>
    </div>
</MudRTLProvider>

@code {
    private int selectedMonth = 1;
    private int selectedYear = 1403;

    private bool week1Locked = false;
    private bool week2Locked = false;
    private bool week3Locked = false;

    public CalendarMont mont = new CalendarMont();
    public List<Food> availableFoods = new List<Food>();
    public Response<List<Food>> resultFoods = new Response<List<Food>>();
    public List<Daily_FoodDTOs> List_Daily_FoodDTOs = new List<Daily_FoodDTOs>();

    protected override async Task OnInitializedAsync()
    {
        await GetDailyFoods();
        resultFoods = await foodServices.GetAllAsync();
        availableFoods = resultFoods.Data!;
        await GetLocalUserFromStorage();
    }

    public void GetMont()
    {
        mont = psc.AutoPersianCalendar();
        selectedMonth = mont.MonthNumber;
    }

    public async Task ChangeMont()
    {
        mont = new CalendarMont();
        availableFoods = new List<Food>();
        resultFoods = new Response<List<Food>>();
        List_Daily_FoodDTOs = new List<Daily_FoodDTOs>();
        mont.MonthNumber = selectedMonth;
        mont = psc.GetMonthCalendar(selectedMonth);
        await GetDailyFoods();
        StateHasChanged();
        await GetFoodAsync();
        StateHasChanged();
    }

    
    protected override void OnInitialized()
    {
        GetMont();
        base.OnInitialized();

    }

    public async Task GetDailyFoods()
    {
        var response = await dailyFoodServices.GetMontAsync(mont.MonthNumber);
        if (response.Data != null)
        {
            var list_daily_foods = response.Data!;
            foreach (var item in list_daily_foods)
            {
                List_Daily_FoodDTOs.Add(new Daily_FoodDTOs() { Date = item.Date, food = item.food!, Mount = item.Mount });
            }
        }
        
        StateHasChanged();
    }

    private async Task GetFoodAsync()
    {
        resultFoods = await foodServices.GetAllAsync();
        availableFoods = resultFoods.Data!;
        StateHasChanged();
    }



    public async Task GetLocalUserFromStorage()
    {
        try
        {

            var result = await LStorage.GetAsync<User>("User");
            if (result.Success && result.Value != null)
            {
                userServices.LocalUser = result.Value;
                StateHasChanged();
            }
            else
            {
                Snackbar.Add("مجددا باید وارد سیستم شوید", Severity.Error);
                NManager.NavigateTo("/", forceLoad: true);
            }
        }
        catch (Exception)
        { NManager.NavigateTo("/", forceLoad: true); }

    }
    private async Task LoadData()
    {
        Snackbar.Add("در حال بارگذاری اطلاعات...", Severity.Info);
        resultFoods = await foodServices.GetAllAsync();
        availableFoods = resultFoods.Data!;
        StateHasChanged();
        Snackbar.Add("اطلاعات با موفقیت بارگذاری شد", Severity.Success);
    }

    private async Task OpenAddFoodDialog()
    {

        // DialogService.ShowAsync<AddFoodDialog>("Options Dialog");
        var dialog = await DialogService.ShowAsync<AddFoodDialog>("افزودن غذای جدید");
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            Snackbar.Add("غذا با موفقیت اضافه شد", Severity.Success);
        }
    }

    private async Task OpenEditFoodDialog()
    {
        resultFoods = await foodServices.GetAllAsync();
        var parameters = new DialogParameters<EditFoodDialog>
        {
            { x => x.Foods, resultFoods.Data }
        };

        var dialog = await DialogService.ShowAsync<EditFoodDialog>("ویرایش غذا", parameters);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            Snackbar.Add("غذا با موفقیت ویرایش شد", Severity.Success);
        }
    }

    private async Task OpenDeleteFoodDialog()
    {
        resultFoods = await foodServices.GetAllAsync();
        var parameters = new DialogParameters<DeleteFoodDialog>
        {
            { x => x.Foods,  resultFoods.Data }
        };

        var dialog = await DialogService.ShowAsync<DeleteFoodDialog>("حذف غذا", parameters);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            Snackbar.Add("غذا با موفقیت حذف شد", Severity.Success);
        }
    }

    private async Task SaveChanges()
    {
        Snackbar.Add("در حال ذخیره تغییرات...", Severity.Info);
        var resuslt = await dailyFoodServices.DeleteMontAsync(mont.MonthNumber);
        await dailyFoodServices.AddListAsync(List_Daily_FoodDTOs);
        Snackbar.Add("تغییرات با موفقیت ذخیره شد", Severity.Success);
    }

    private void CancelChanges()
    {

        Snackbar.Add("تغییرات لغو شد", Severity.Warning);
    }


    private void OnSelectionChanged(IEnumerable<Food> args, DateOnly date)
    {
        try
        {
            List_Daily_FoodDTOs.RemoveAll(sabt => sabt.Date.Equals(date));
        }
        catch
        {
            List_Daily_FoodDTOs.RemoveAll(sabt => sabt.Date.Equals(date));
        }
        foreach (var item in args)
        {
            var DF = new Daily_FoodDTOs() { food = item, Date = date, Mount = mont.MonthNumber };
            List_Daily_FoodDTOs.Add(DF);
        }
        StateHasChanged();
    }
}